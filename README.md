//одним пакетным запросом найти ВСЕХ предков (потомков) в иерархическом справочнике
//третий параметр - ВТ, возможно не пустая!

Функция ТранзитивноеЗамыкание(ИмяСправочника, МаксимальнаяДлинаПути, МенеджерВТ) Экспорт
	
	Пролог = "ВЫБРАТЬ Родитель НачалоДуги, Ссылка КонецДуги ПОМЕСТИТЬ ЗамыканияДлины1 ИЗ ПланВидовХарактеристик.СчетаРасходов
	
		| ГДЕ Родитель <> Значение(ПланВидовХарактеристик.СчетаРасходов.ПустаяСсылка) 
		
		| ОБЪЕДИНИТЬ ВЫБРАТЬ Ссылка, Ссылка ИЗ ПланВидовХарактеристик.СчетаРасходов;";
			
    Рефрен = "ВЫБРАТЬ РАЗЛИЧНЫЕ ПерваяДуга.НачалоДуги, ВтораяДуга.КонецДуги ПОМЕСТИТЬ ЗамыканияДлины#2 ИЗ ЗамыканияДлины#1 КАК ПерваяДуга

            | ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗамыканияДлины#1 КАК ВтораяДуга ПО ПерваяДуга.КонецДуги = ВтораяДуга.НачалоДуги;

            | УНИЧТОЖИТЬ ЗамыканияДлины#1;";
	
    Эпилог = "ВЫБРАТЬ НачалоДуги Предок, КонецДуги Потомок Поместить Табл ИЗ ЗамыканияДлины#2 ГДЕ НачалоДуги <> КонецДуги и НЕ КонецДуги.ЭтоГруппа и НачалоДуги.Код в (&СписокГрупп)";

    Запрос = Новый Запрос(СтрЗаменить(Пролог, "СчетаРасходов", ИмяСправочника));

    МаксимальнаяДлинаЗамыканий = 1;

    Пока МаксимальнаяДлинаЗамыканий < МаксимальнаяДлинаПути Цикл

        Запрос.Текст = Запрос.Текст + СтрЗаменить(СтрЗаменить(Рефрен, "#1", Формат(МаксимальнаяДлинаЗамыканий, "ЧГ=0")), "#2", Формат(2 * МаксимальнаяДлинаЗамыканий, "ЧГ=0"));

        МаксимальнаяДлинаЗамыканий = 2 * МаксимальнаяДлинаЗамыканий

    КонецЦикла;
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
    Запрос.Текст = Запрос.Текст + СтрЗаменить(Эпилог, "#2", Формат(МаксимальнаяДлинаЗамыканий, "ЧГ=0")); 
	СписокГрупп = Новый массив;
	СписокГрупп.Добавить("000000014");
	СписокГрупп.Добавить("000000004");
	Запрос.УстановитьПараметр("СписокГрупп", СписокГрупп);
	//при выполнении запроса, в наш МВТ добавиться новая ВТ
    Возврат Запрос.Выполнить();

КонецФункции   


//событие чтобы запихать в отчет свою ВТ из функции выше

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
		
	СтандартнаяОбработка = Ложь;
	МенеджерВТ = Новый МенеджерВременныхТаблиц;
	Замыкание.ТранзитивноеЗамыкание("СчетаРасходов", 1024, МенеджерВТ);
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновкиДанных = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, КомпоновщикНастроек.ПолучитьНастройки(), 
							ДанныеРасшифровки,, Тип("ГенераторМакетаКомпоновкиДанных"));
	
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновкиДанных,, ДанныеРасшифровки, Истина,, МенеджерВТ);
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);
								
КонецПроцедуры
                      
ссылка на статью 
https://infostart.ru/1c/articles/158512/
